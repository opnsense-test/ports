--- genconfig.sh.clean	2016-01-01 06:17:25.000000000 -0500
+++ genconfig.sh	2018-06-13 17:08:58.001871000 -0400
@@ -92,6 +92,13 @@
 	OS_VERSION="Tomato $TOMATO_VER"
 fi
 
+# OPNsense special case
+if [ -f /usr/local/opnsense/version/opnsense ]; then
+	OS_NAME=OPNsense
+	OPNSENSE_VER=`cat /usr/local/opnsense/version/opnsense`
+	OS_VERSION="OPNsense $OPNSENSE_VER"
+fi
+
 ${RM} ${CONFIGFILE}
 
 echo "/* MiniUPnP Project" >> ${CONFIGFILE}
@@ -186,6 +193,17 @@
 		OS_URL=http://www.freebsd.org/
 		V6SOCKETS_ARE_V6ONLY=`sysctl -n net.inet6.ip6.v6only`
 		;;
+	OPNsense)
+		# Handle this more gracefully
+		FW=pf
+		OS_URL=https://www.opnsense.org
+		# Use post-FreeBSD 7.x multicast struct
+		HAVE_IP_MREQN=1
+		# Enable PORTINUSE check
+		PORTINUSE=true
+		# Enable IPv6
+		IPV6=true
+		;;
 	pfSense)
 		# we need to detect if PFRULE_INOUT_COUNTS macro is needed
 		FW=pf
@@ -410,7 +428,7 @@
 
 echo "/* Uncomment the following line to enable generation of" >> ${CONFIGFILE}
 echo " * filter rules with pf */" >> ${CONFIGFILE}
-echo "/*#define PF_ENABLE_FILTER_RULES*/">> ${CONFIGFILE}
+echo "#define PF_ENABLE_FILTER_RULES">> ${CONFIGFILE}
 echo "" >> ${CONFIGFILE}
 
 echo "/* Uncomment the following line to enable caching of results of" >> ${CONFIGFILE}
